# üèóÔ∏è Arquitectura del Sistema - Documentaci√≥n T√©cnica

## Resumen Arquitect√≥nico

El sistema CrossFit Reservas MVP implementa una arquitectura en capas que separa claramente las responsabilidades entre la API, l√≥gica de negocio y automatizaci√≥n web. Esta documentaci√≥n describe la estructura, patrones de dise√±o y decisiones t√©cnicas implementadas.

## üìê Vista General de la Arquitectura

```mermaid
graph TB
    subgraph "üåê Presentation Layer"
        A[FastAPI Application]
        B[Swagger/OpenAPI Docs]
        C[Health Check Endpoints]
    end
    
    subgraph "üéØ Business Logic Layer"
        D[ReservationManager]
        E[ConfigManager]
        F[Request/Response Models]
    end
    
    subgraph "ü§ñ Service Layer"
        G[WebAutomationService]
        H[Playwright Integration]
    end
    
    subgraph "üìä Data Layer"
        I[Configuration Files]
        J[Environment Variables]
        K[Logging System]
    end
    
    subgraph "üåç External Layer"
        L[Chromium Browser]
        M[CrossFit Website]
        N[Docker Environment]
    end
    
    A --> D
    A --> F
    B --> A
    C --> A
    D --> E
    D --> G
    E --> I
    F --> D
    G --> H
    H --> L
    L --> M
    K --> G
    J --> G
    N --> A
```

## üéØ Patr√≥n de Arquitectura: Layered Architecture

### Principios Aplicados

1. **Separation of Concerns**: Cada capa tiene una responsabilidad espec√≠fica
2. **Dependency Inversion**: Las capas superiores dependen de abstracciones
3. **Single Responsibility**: Cada clase tiene una √∫nica raz√≥n para cambiar
4. **Don't Repeat Yourself**: L√≥gica com√∫n centralizada

## üì¶ Componentes por Capa

### üåê Presentation Layer (API)

```mermaid
classDiagram
    class FastAPIApp {
        +title: str
        +description: str  
        +version: str
        +startup_event()
        +shutdown_event()
    }
    
    class ReservasRouter {
        +reserva_inmediata(request)
        +prefix: "/api"
        +tags: ["Reservas"]
    }
    
    class HealthRouter {
        +health_check()
        +root()
    }
    
    FastAPIApp --> ReservasRouter
    FastAPIApp --> HealthRouter
```

**Responsabilidades:**
- Recepci√≥n de requests HTTP
- Validaci√≥n de entrada con Pydantic
- Serializaci√≥n de respuestas JSON
- Documentaci√≥n autom√°tica
- Manejo de CORS

**Archivos:**
- `app/main.py` - Aplicaci√≥n principal
- `app/api/reservas.py` - Endpoints de reservas

### üéØ Business Logic Layer

```mermaid
classDiagram
    class ReservationManager {
        -config_manager: ConfigManager
        -web_automation: WebAutomationService
        +execute_immediate_reservation(nombre_clase, fecha)
        +get_available_classes()
    }
    
    class ConfigManager {
        -config_path: str
        +get_clase_by_nombre(nombre)
        +get_clases_activas()
        +load_config()
    }
    
    class ReservaModels {
        +ReservaInmediataRequest
        +ReservaResponse  
        +EstadoReserva
        +ClaseConfig
    }
    
    ReservationManager --> ConfigManager
    ReservationManager --> ReservaModels
```

**Responsabilidades:**
- Orquestaci√≥n del flujo de reserva
- Validaci√≥n de reglas de negocio
- Gesti√≥n de configuraci√≥n de clases
- Transformaci√≥n de datos
- Logging de eventos importantes

**Archivos:**
- `app/services/reservation_manager.py` - Orquestador principal
- `app/services/config_manager.py` - Gesti√≥n de configuraci√≥n
- `app/models/reserva.py` - Modelos de datos

### ü§ñ Service Layer (Automation)

```mermaid
classDiagram
    class WebAutomationService {
        -crossfit_url: str
        -username: str
        -password: str
        -headless: bool
        +realizar_reserva(clase_nombre, fecha)
        +validate_credentials()
        -_navigate_to_site()
        -_perform_login()
        -_select_class()
        -_execute_reservation()
    }
    
    class PlaywrightIntegration {
        +browser: Browser
        +page: Page
        +launch_browser()
        +close_browser()
    }
    
    WebAutomationService --> PlaywrightIntegration
```

**Responsabilidades:**
- Automatizaci√≥n de navegaci√≥n web
- Gesti√≥n del ciclo de vida del navegador
- Interacci√≥n con elementos DOM
- Manejo de errores de navegaci√≥n
- Soporte multiidioma (ES/EN)

**Archivos:**
- `app/services/web_automation.py` - Automatizaci√≥n principal
- `app/services/mcp_automation.py` - Integraci√≥n MCP (futuro)

### üìä Data Layer

```mermaid
classDiagram
    class ConfigurationFiles {
        +clases.json
        +load_json()
        +validate_schema()
    }
    
    class EnvironmentConfig {
        +CROSSFIT_URL
        +USERNAME  
        +PASSWORD
        +BROWSER_HEADLESS
        +LOG_LEVEL
    }
    
    class LoggingSystem {
        +loguru_logger
        +format_logs()
        +set_level()
    }
```

**Responsabilidades:**
- Persistencia de configuraci√≥n
- Gesti√≥n de variables de entorno
- Sistema de logging estructurado
- Validaci√≥n de datos de entrada

**Archivos:**
- `config/clases.json` - Configuraci√≥n de clases
- `.env` - Variables de entorno
- Logging integrado en todos los servicios

## üîÑ Flujo de Datos

```mermaid
sequenceDiagram
    participant C as Client
    participant API as FastAPI
    participant RM as ReservationManager
    participant CM as ConfigManager
    participant WA as WebAutomationService
    participant P as Playwright
    participant W as Website
    
    C->>API: POST /api/reservas/inmediata
    API->>API: Validate request (Pydantic)
    API->>RM: execute_immediate_reservation()
    
    RM->>CM: get_clase_by_nombre()
    CM-->>RM: ClaseConfig | None
    
    RM->>WA: validate_credentials()
    WA-->>RM: bool
    
    RM->>WA: realizar_reserva()
    WA->>P: Launch browser
    P->>W: Navigate + Login + Reserve
    W-->>P: HTML responses
    P-->>WA: DOM events
    WA-->>RM: Result dict
    
    RM->>RM: Transform to ReservaResponse
    RM-->>API: ReservaResponse
    API-->>C: JSON response
```

## üõ†Ô∏è Patrones de Dise√±o Implementados

### 1. **Facade Pattern**
`ReservationManager` act√∫a como fachada que simplifica las interacciones complejas:

```python
class ReservationManager:
    def execute_immediate_reservation(self, nombre_clase: str, fecha: str):
        # Orquesta m√∫ltiples servicios de forma simple
        config = self.config_manager.get_clase_by_nombre(nombre_clase)
        result = self.web_automation.realizar_reserva(nombre_clase, fecha)
        return self._transform_response(result)
```

### 2. **Strategy Pattern** 
Diferentes estrategias de detecci√≥n basadas en el contexto:

```python
# Estrategia para modo headless vs visual
if self.headless:
    # Priorizar selectores en ingl√©s
    await page.wait_for_selector('button:has-text("Book")')
else:
    # Priorizar selectores en espa√±ol  
    await page.wait_for_selector('button:has-text("Reservar")')
```

### 3. **Factory Pattern**
Configuraci√≥n din√°mica del navegador:

```python
def create_browser_config(headless: bool) -> dict:
    if headless:
        return {
            'headless': True,
            'args': ['--no-sandbox', '--disable-gpu']
        }
    else:
        return {
            'headless': False, 
            'slow_mo': 50
        }
```

### 4. **Command Pattern**
Cada paso de automatizaci√≥n encapsulado:

```python
async def _step_1_navigate(self, page):
    """Comando: Navegar al sitio"""
    await page.goto(self.crossfit_url)
    
async def _step_2_login(self, page):  
    """Comando: Realizar login"""
    await self._fill_credentials(page)
    
async def _step_3_select_class(self, page, clase_nombre):
    """Comando: Seleccionar clase"""
    await page.click(f'text="{clase_nombre}"')
```

## üîí Manejo de Errores y Resilencia

### Jerarqu√≠a de Excepciones

```mermaid
classDiagram
    class ErrorHandler {
        +handle_credentials_error()
        +handle_no_cupos_error()
        +handle_unexpected_error()
    }
    
    class ErrorTypes {
        NO_CUPOS
        CREDENTIALS_ERROR  
        UNEXPECTED_ERROR
    }
    
    class RetryStrategy {
        +should_retry(error_type)
        +get_backoff_delay()
    }
    
    ErrorHandler --> ErrorTypes
    ErrorHandler --> RetryStrategy
```

### Estrategias de Recuperaci√≥n

| Error Type | Strategy | Retry | Notification |
|------------|----------|--------|-------------|
| `NO_CUPOS` | Fail fast | ‚ùå No | ‚ÑπÔ∏è Info |
| `CREDENTIALS_ERROR` | Fail fast | ‚ùå No | ‚ö†Ô∏è Warning |
| `UNEXPECTED_ERROR` | Graceful degradation | ‚úÖ Yes | üö® Alert |

## üìä Configuraci√≥n y Extensibilidad

### Sistema de Configuraci√≥n

```mermaid
graph TD
    A[Application Startup] --> B{Load .env}
    B --> C[Validate Required Vars]
    C --> D{Load clases.json}
    D --> E[Validate JSON Schema]
    E --> F[Initialize Services]
    F --> G[Ready to Serve]
    
    C -->|Missing vars| H[Startup Error]
    E -->|Invalid schema| H
```

### Puntos de Extensi√≥n

1. **Nuevos tipos de reserva:**
```python
# Agregar en reservation_manager.py
async def execute_scheduled_reservation(self, clase_id: str, schedule_time: datetime):
    # Implementar l√≥gica de programaci√≥n
    pass
```

2. **Nuevos proveedores de navegaci√≥n:**
```python
# Crear nueva implementaci√≥n
class SeleniumAutomationService(BaseAutomationService):
    async def realizar_reserva(self, clase_nombre: str, fecha: str):
        # Implementaci√≥n con Selenium
        pass
```

3. **Nuevas fuentes de configuraci√≥n:**
```python
# Implementar interfaz
class DatabaseConfigManager(BaseConfigManager):
    def get_clases_activas(self):
        # Cargar desde base de datos
        pass
```

## üê≥ Infraestructura y Deployment

### Containerizaci√≥n

```mermaid
graph TB
    subgraph "üê≥ Docker Container"
        A[Python 3.12 Slim Base]
        B[System Dependencies<br/>Chromium + libs]
        C[Python Dependencies<br/>FastAPI + Playwright]
        D[Application Code]
        E[Non-root User]
    end
    
    subgraph "üîß Build Process"
        F[Multi-stage Build]
        G[Dependency Caching]
        H[Security Hardening]
    end
    
    A --> B
    B --> C  
    C --> D
    D --> E
    
    F --> A
    G --> C
    H --> E
```

### Optimizaciones de Contenedor

1. **Multi-stage build** para reducir tama√±o final
2. **Dependency caching** para builds m√°s r√°pidos  
3. **Non-root user** para seguridad
4. **Health checks** removidos para desarrollo

## üìà M√©tricas y Observabilidad

### Logging Estructurado

```python
# Formato consistente en toda la aplicaci√≥n
logger.info(f"üöÄ Iniciando reserva para: {clase_nombre}")
logger.warning(f"‚ö†Ô∏è Sin cupos para: {clase_nombre}")  
logger.error(f"‚ùå Error en reserva: {error}")
logger.success(f"‚úÖ Reserva exitosa: {clase_nombre}")
```

### Puntos de Instrumentaci√≥n

1. **Request/Response timing**
2. **Browser automation steps**  
3. **Error rates por tipo**
4. **Success rates por clase/horario**

## üöÄ Roadmap Arquitect√≥nico

### Fase 1: MVP Actual ‚úÖ
- API REST b√°sica
- Automatizaci√≥n web
- Manejo de errores
- Dockerizaci√≥n

### Fase 2: Scheduler üöß
- Sistema de cron jobs
- Persistencia de tareas  
- Notificaciones
- Dashboard b√°sico

### Fase 3: Escalabilidad üìã
- Base de datos
- Cache (Redis)
- Queue system (Celery)
- Load balancing

### Fase 4: Observabilidad üìã
- M√©tricas (Prometheus)
- Tracing (Jaeger)
- Alerting (AlertManager)
- Dashboard (Grafana)

## üîß Decisiones T√©cnicas Clave

### 1. **FastAPI sobre Flask**
- ‚úÖ Validaci√≥n autom√°tica con Pydantic
- ‚úÖ Documentaci√≥n autom√°tica  
- ‚úÖ Type hints nativo
- ‚úÖ Performance superior

### 2. **Playwright sobre Selenium**
- ‚úÖ M√°s r√°pido y estable
- ‚úÖ Mejor soporte headless
- ‚úÖ API m√°s moderna
- ‚úÖ Debugging tools integrados

### 3. **Docker Compose sobre K8s**
- ‚úÖ Simplicidad para MVP
- ‚úÖ Desarrollo local facilitado
- ‚úÖ Menos overhead
- ‚úÖ Migraci√≥n futura posible

### 4. **Loguru sobre logging est√°ndar**  
- ‚úÖ Configuraci√≥n m√°s simple
- ‚úÖ Formato m√°s legible
- ‚úÖ Colores en desarrollo
- ‚úÖ Structured logging

## üîê Consideraciones de Seguridad

### Principios Aplicados

1. **Least Privilege**: Container no-root user
2. **Environment Isolation**: Variables sensibles en .env
3. **Input Validation**: Pydantic models
4. **Error Handling**: No exposici√≥n de detalles internos

### Vulnerabilidades Mitigadas

- ‚úÖ **Injection attacks**: Validaci√≥n de entrada
- ‚úÖ **Privilege escalation**: Non-root container  
- ‚úÖ **Information disclosure**: Logging sanitizado
- ‚úÖ **CORS attacks**: Configuraci√≥n restrictiva
